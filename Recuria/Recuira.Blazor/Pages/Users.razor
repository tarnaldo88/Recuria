@page "/users"
@inject Recuira.Blazor.Services.AuthState Auth
@inject Recuria.Client.IRecuriaApiClient Api
@using System.Globalization

<PageTitle>Users</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4">Users</MudText>

    @if(!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Success" Dense="true">@_info</MudAlert>
    }

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Organization Summary</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            @if(_org is null)
            {
                <MudText Typo="Typo.body2">Loading Organization...</MudText>
            }
            else
            {
                <MudText><b>Name:</b> @_org.Name</MudText>
                <MudText><b>Owner:</b> @_org.OwnerEmail</MudText>
                <MudText><b>User Count:</b> @_org.UserCount</MudText>
                <MudText><b>Org Id:</b> @_org.Id</MudText>
            }
        </MudCardContent>
    </MudCard>

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Add User</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="_newName" Label="Name" Variant="Variant.Outlined"/>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="_newEmail" Label="Email" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="2">
                    <MudSelect T="Recuria.Client.UserRole" @bind-Value="_newRole" Label="Role" Variant="Variant.Outlined">
                        <MudSelectItem Value="Recuria.Client.UserRole.Owner">Owner</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Admin">Admin</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Member">Member</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="2" Class="d-flex align-end">
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true" Disabled="_busy" OnClick="AddUser">
                        Add
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">User Actions(Lookup by Id)</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="8">
                    <MudTextField @bind-Value="_lookupUserId" Label="User Id (GUID)" Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" md="4" Class="d-flex align-end">
                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true" Disabled="_busy" OnClick="LookupUser">
                        Lookup
                    </MudButton>
                </MudItem>
            </MudGrid>

            @if(_selectedUser is not null)
            {
                <MudDivider Class="my-3" />
                <MudText><b>Name:</b> @_selectedUser.Name</MudText>
                <MudText><b>Email:</b> @_selectedUser.Email</MudText>
                <MudText><b>Role:</b> @_selectedUser.Role</MudText>
                <MudText><b>Organization:</b> @_selectedUser.OrganizationId</MudText>

                <MudStack Row="true" Spacing="2" Class="mt-3">
                    <MudSelect T="Recuria.Client.UserRole" @bind-Value="_selectedRole" Label="New Role" Variant="Variant.Outlined">
                        <MudSelectItem Value="Recuria.Client.UserRole.Owner">Owner</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Admin">Admin</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Member">Member</MudSelectItem>
                    </MudSelect>

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_busy" OnClick="ChangeRole">
                        Update Role
                    </MudButton>

                    <MudButton Variant="Variant.Outlined" Color="Color.Error" Disabled="_busy" OnClick="RemoveUser">
                        Remove User
                    </MudButton>
                </MudStack>
            }
        </MudCardContent>

        <MudTable T="Recuria.Client.User" Items="FilteredUsers" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Id</MudTh>
                <MudTh>Name</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Role</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Id</MudTd>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.Email</MudTd>
                <MudTd>@context.Role</MudTd>
                <MudTd>
                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Disabled="_busy" OnClick="@(() => SelectUser(context))">Select</MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Disabled="_busy" OnClick="@(() => RemoveUser(context.Id))">Remove</MudButton>
                    </MudStack>
                </MudTd>
            </RowTemplate>
        </MudTable>
    </MudCard>
    </MudStack>

@code {
    private bool _busy;
    private string? _error;
    private string? _info;
    private Guid _orgId;
    private Recuria.Client.OrganizationDto? _org;

    private string? _search;
    private string? _newName;
    private string? _newEmail;
    private Recuria.Client.UserRole _newRole = Recuria.Client.UserRole.Member;

    private List<Recuria.Client.User> _users = new();
    private string? _lookupUserId;
    private Recuria.Client.User? _selectedUser;
    private Recuria.Client.UserRole _selectedRole = Recuria.Client.UserRole.Member;

    private IEnumerable<Recuria.Client.User> FilteredUsers =>
        string.IsNullOrWhiteSpace(_search)
            ? _users
            : _users.Where(u =>
                (u.Name ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                (u.Email ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var orgIdRaw = await Auth.GetOrgIdAsync();
        if(string.IsNullOrWhiteSpace(orgIdRaw))
        {
            _error = "No organization id found. Go to /bootstrap first.";
            return;
        }

        _orgId = Guid.Parse(orgIdRaw);
        await LoadContext();
    }

    private async Task LoadContext()
    {
        _error = null;
        _info = null;
        var orgIdRaw = await Auth.GetOrgIdAsync();

        if(string.IsNullOrWhiteSpace(orgIdRaw))
        {
            _error = "No organization id found. Go to /bootstrap first.";
            return;
        }

        _orgId = Guid.Parse(orgIdRaw);
        _org = await Api.MeAsync();
    }

    private async Task AddUser()
    {
        _busy = true;
        _error = null;
        _info = null;

        try
        {
            await Api.UsersPOSTAsync(_orgId, new Recuria.Client.AddUserRequest
            {
                UserId = Guid.NewGuid(),
                Name = string.IsNullOrWhiteSpace(_newName) ? _newEmail : _newName,
                Email = _newEmail?.Trim(),
                Role = _newRole
            });
            _info = "User added.";
            await LoadContext();
        }
        catch (Recuria.Client.ApiException ex) when (ex.StatusCode == 204) // stale client expecting 200
        {
            _info = "User added.";
            await LoadContext();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _busy = false; }
    }

    private async Task LookupUser()
    {
        _busy = true;
        _error = null;
        _info = null;

        try
        {
            if(!Guid.TryParse(_lookupUserId, out var userId))
            {
                _error = "Enter a valid user id.";
                return;
            }

            _selectedUser = await Api.UsersGETAsync(userId);
            _selectedRole = _selectedUser.Role;
        }
        catch(Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private void SelectUser(Recuria.Client.User user)
    {
        _selectedUser = user;
        _selectedRole = user.Role;
    }

    private async Task ChangeRole()
    {
        if (_selectedUser is null)
            return;

        _busy = true;
        _error = null;
        _info = null;

        try
        {
            await Api.RoleAsync(_orgId, _selectedUser.Id, new Recuria.Client.ChangeUserRoleRequest { NewRole = _selectedRole });
            _info = "Role updated.";
            await LookupUser();
        }
        catch (Recuria.Client.ApiException ex) when (ex.StatusCode == 204)
        {
            _info = "Role updated.";
            await LookupUser();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task RemoveUser()
    {
        if (_selectedUser is null)
            return;

        _busy = true;
        _error = null;
        _info = null;

        try
        {
            await Api.UsersDELETEAsync(_orgId, _selectedUser.Id);
            _info = "User removed.";
            _selectedUser = null;
            await LoadContext();
        }
        catch (Recuria.Client.ApiException ex) when (ex.StatusCode == 204)
        {
            _info = "User removed.";
            _selectedUser = null;
            await LoadContext();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }
}
