@page "/users"
@inject Recuira.Blazor.Services.AuthState Auth
@inject Recuria.Client.IRecuriaApiClient Api
@using System.Globalization

<PageTitle>Users</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4" Style="color:#ffff">Users</MudText>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">@_error</MudAlert>
    }

    @if (!string.IsNullOrWhiteSpace(_info))
    {
        <MudAlert Severity="Severity.Success" Dense="true">@_info</MudAlert>
    }

    <MudCard>
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="_search"
                                  Label="Search name or email"
                                  Variant="Variant.Outlined"
                                  Immediate="true" />
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="_newName" Label="Name" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="_newEmail" Label="Email" Variant="Variant.Outlined" />
                </MudItem>

                <MudItem xs="12" md="2">
                    <MudSelect T="Recuria.Client.UserRole" @bind-Value="_newRole" Label="Role" Variant="Variant.Outlined">
                        <MudSelectItem Value="Recuria.Client.UserRole.Owner">Owner</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Admin">Admin</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Member">Member</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudStack Row="true" Spacing="2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_busy" OnClick="AddUser">Add User</MudButton>
                        <MudButton Variant="Variant.Outlined" Disabled="_busy" OnClick="LoadUsers">Refresh</MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <MudTable T="Recuria.Client.UserSummaryDto" Items="FilteredUsers" Dense="true" Hover="true">
        <HeaderContent>
            <MudTh>Name</MudTh>
            <MudTh>Email</MudTh>
            <MudTh>Role</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.Name</MudTd>
            <MudTd>@context.Email</MudTd>
            <MudTd>@context.Role</MudTd>
            <MudTd>
                <MudStack Row="true" Spacing="1">
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Disabled="_busy" OnClick="@(() => SelectUser(context))">Select</MudButton>
                    <MudButton Variant="Variant.Text" Color="Color.Error" Disabled="_busy" OnClick="@(() => RemoveUser(context.Id))">Remove</MudButton>
                </MudStack>
            </MudTd>
        </RowTemplate>
        <NoRecordsContent>
            <MudText Typo="Typo.body2">No users found.</MudText>
        </NoRecordsContent>
    </MudTable>

    @if (_selectedUser is not null)
    {
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Edit Role - @_selectedUser.Email</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                    <MudSelect T="Recuria.Client.UserRole" @bind-Value="_selectedRole" Label="New Role" Variant="Variant.Outlined">
                        <MudSelectItem Value="Recuria.Client.UserRole.Owner">Owner</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Admin">Admin</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Member">Member</MudSelectItem>
                    </MudSelect>

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_busy" OnClick="ChangeRole">Update Role</MudButton>
                </MudStack>
            </MudCardContent>
        </MudCard>
    }
</MudStack>

@code {
    private bool _busy;
    private string? _error;
    private string? _info;
    private Guid _orgId;
    private Recuria.Client.OrganizationDto? _org;

    private string? _search;
    private string? _newName;
    private string? _newEmail;
    private Recuria.Client.UserRole _newRole = Recuria.Client.UserRole.Member;

    private List<Recuria.Client.UserSummaryDto> _users = new();
    private Recuria.Client.UserSummaryDto? _selectedUser;
    private Recuria.Client.UserRole _selectedRole = Recuria.Client.UserRole.Member;

    private IEnumerable<Recuria.Client.UserSummaryDto> FilteredUsers =>
        string.IsNullOrWhiteSpace(_search)
            ? _users
            : _users.Where(u =>
                (u.Name ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                (u.Email ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var orgIdRaw = await Auth.GetOrgIdAsync();
        if(string.IsNullOrWhiteSpace(orgIdRaw))
        {
            _error = "No organization id found. Go to /bootstrap first.";
            return;
        }

        _orgId = Guid.Parse(orgIdRaw);
        await LoadContext();
    }

    private async Task LoadContext()
    {
        _error = null;
        _info = null;
        var orgIdRaw = await Auth.GetOrgIdAsync();

        if(string.IsNullOrWhiteSpace(orgIdRaw))
        {
            _error = "No organization id found. Go to /bootstrap first.";
            return;
        }

        _orgId = Guid.Parse(orgIdRaw);
        _org = await Api.MeAsync();
    }

    private async Task AddUser()
    {
        _busy = true;
        _error = null;
        _info = null;

        try
        {
            await Api.UsersPOSTAsync(_orgId, new Recuria.Client.AddUserRequest
            {
                UserId = Guid.NewGuid(),
                Name = string.IsNullOrWhiteSpace(_newName) ? _newEmail : _newName,
                Email = _newEmail?.Trim(),
                Role = _newRole
            });
            _info = "User added.";
            await LoadContext();
        }
        catch (Recuria.Client.ApiException ex) when (ex.StatusCode == 204) // stale client expecting 200
        {
            _info = "User added.";
            await LoadContext();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _busy = false; }
    }

    private async Task LoadUsers()
    {
        _busy = true; _error = null; _info = null;
        try
        {
            // Replace with your generated NSwag method name for:
            // GET /api/organizations/{id}/users
            // Example: _users = (await Api.UsersGET2Async(_orgId)).ToList();
            _users = (await Api.UsersAllAsync(_orgId)).ToList();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _busy = false; }
    }

    private void SelectUser(Recuria.Client.UserSummaryDto user)
    {
        _selectedUser = user;
        _selectedRole = user.Role;
    }

    private async Task ChangeRole()
    {
        if (_selectedUser is null) return;

        _busy = true; _error = null; _info = null;
        try
        {
            await Api.RoleAsync(_orgId, _selectedUser.Id, new Recuria.Client.ChangeUserRoleRequest
            {
                NewRole = _selectedRole
            });

            _info = "Role updated.";
            await LoadUsers();
        }
        catch (Recuria.Client.ApiException ex) when (ex.StatusCode == 204)
        {
            _info = "Role updated.";
            await LoadUsers();
        }
        catch (Exception ex) { _error = ex.Message; }
        finally { _busy = false; }
    }

    private async Task RemoveUser(Guid userId)
    {
        if (_selectedUser is null)
            return;

        _busy = true;
        _error = null;
        _info = null;

        try
        {
            await Api.UsersDELETEAsync(_orgId, _selectedUser.Id);
            _info = "User removed.";
            _selectedUser = null;
            await LoadContext();
        }
        catch (Recuria.Client.ApiException ex) when (ex.StatusCode == 204)
        {
            _info = "User removed.";
            _selectedUser = null;
            await LoadContext();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }
}
