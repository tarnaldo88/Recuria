@page "/login"
@inject Recuria.Client.IRecuriaApiClient Api
@inject Recuira.Blazor.Services.AuthState Auth
@inject NavigationManager Nav

<PageTitle>Login</PageTitle>

@code {
    [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }

    private string _orgName = "Acme Inc";
    private string _ownerEmail = "owner@recuria.local";
    private string _ownerName = "Owner One";
    private bool _busy;
    private string? _error;

    private async Task SignIn()
    {
        _busy = true;
        _error = null;

        try
        {
            var result = await Api.BootstrapAsync(new Recuria.Client.BootstrapRequest
            {
                OrganizationName = _orgName,
                OwnerEmail = _ownerEmail,
                OwnerName = _ownerName
            });

            await Auth.SetAuthAsync(result.Token!, result.OrganizationId.ToString());

            var target = string.IsNullOrWhiteSpace(ReturnUrl) ? "/dashboard" : ReturnUrl;
            Nav.NavigateTo(target, forceLoad: false);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }
}
