@page "/invoices/{InvoiceId:guid}"
@inject Recuria.Client.IRecuriaApiClient Api
@inject NavigationManager Nav
@using System.Globalization;

<PageTitle>Invoice Details</PageTitle>

<MudStack Spacing="3">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <MudText Typo="Typo.h4">Invoice Details</MudText>
        <MudButton Variant="Variant.Outlined"  OnClick="@(() => Nav.NavigateTo("/invoices"))">
            Back to Invoices
        </MudButton>
    </MudStack>

    @if(!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">
            @_error
        </MudAlert>
    }
    else if(_loading)
    {
        <MudSkeleton Height="220px" Width="100%"/>
    }
    else if(_invoice is null)
    {
        <MudAlert Severity="Severity.Warning" Dense="true">
            Invoice not found.
        </MudAlert>
    }
    else
    {
        <MudCard>
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">
                        Invoice #@(_invoice.InvoiceNumber ?? _invoice.Id.ToString())
                    </MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_invoice.Status)">
                        @(_invoice.Status ?? "Unknown")
                    </MudChip>
                </CardHeaderActions>
            </MudCardHeader>

            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" md="6">
                        <MudText><b>Issued:</b> @_invoice.IssuedOnUtc.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudText>
                        <MudText><b>Paid:</b> @_invoice.PaidOnUtc?.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudText>
                    </MudItem>
                    <MudItem xs="12" md="6">
                        <MudText><b>Subtotal:</b> @FormatMoney(_invoice.Subtotal?.Amount, _invoice.Subtotal?.Currency)</MudText>
                        <MudText><b>Tax:</b> @FormatMoney(_invoice.Tax?.Amount, _invoice.Tax?.Currency)</MudText>
                        <MudText><b>Total:</b> @FormatMoney(_invoice.Total?.Amount, _invoice.Total?.Currency)</MudText>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>
    }
    </MudStack>

@code {
    [Parameter] public Guid InvoiceId { get; set; }

    private string? _error;
    private bool _loading;
    private Recuria.Client.InvoiceDetailsDto? _invoice;

    protected override async Task OnParametersSetAsync()
    {
        _loading = true;
        _error = null;

        try
        {
            _invoice = await Api.InvoicesGETAsync(InvoiceId);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private static string FormatMoney(double? amount, string? currency)
    {
        var value = amount ?? 0;
        var code = string.IsNullOrWhiteSpace(currency) ? "USD" : currency.ToUpperInvariant();
        var symbol = code == "USD" ? "$" : code + " ";
        return $"{symbol}{value:N2}";
    }

    private static Color GetStatusColor(string? status) =>
        status?.ToLowerInvariant() switch
        {
            "paid" => Color.Success,
            "open" => Color.Info,
            "pending" => Color.Warning,
            "failed" => Color.Error,
            "void" => Color.Default,
            _ => Color.Default
        };
}
