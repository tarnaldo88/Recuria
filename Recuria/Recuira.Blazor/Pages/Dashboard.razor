@page "/dashboard"
@inject Recuira.Blazor.Services.AuthState Auth
@inject Recuria.Client.IRecuriaApiClient Api

<PageTitle>Dashboard</PageTitle>

<MudStack Spacing="3">
    <MudText Style="color:#ffff" Typo="Typo.h4">Dashboard</MudText>

    @if (_loading)
    {
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudSkeleton Height="180px" Width="100%" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSkeleton Height="180px" Width="100%" />
            </MudItem>
        </MudGrid>
    }
    else if (_error is not null)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">
            @_error
        </MudAlert>

        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/bootstrap" StartIcon="@Icons.Material.Filled.RocketLaunch">
            Go to Bootstrap
        </MudButton>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Organization</MudText>
                            <MudText>@orgName</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="1">
                            <MudText><b>Plan:</b>@_subscription?.Subscription?.PlanCode</MudText>
                            <MudText>
                                <b>Status:</b>
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_subscription?.Subscription?.Status)">
                                    @(_subscription?.Subscription?.Status.ToString() ?? "Unknown")
                                </MudChip>
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
    </MudStack>

@code {
    private bool _loading = true;
    private string? _error;
    private Recuria.Client.OrganizationDto? _org;
    private Recuria.Client.SubscriptionDetailsDto? _subscription;
    private string? orgName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var orgId = await Auth.GetOrgIdAsync();
            if(string.IsNullOrWhiteSpace(orgId))
            {
                _error = "No org id. Go to /bootstrap.";
                return;
            }

            var parsedOrgId = Guid.Parse(orgId);
            _org = await Api.OrganizationsGETAsync(parsedOrgId);
            _subscription = await Api.CurrentAsync(parsedOrgId);
            orgName = _org.Name ?? "unknown";
        }
        catch(Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }

    private static Color GetStatusColor(Recuria.Client.SubscriptionStatus? status) =>
     status switch
     {
         Recuria.Client.SubscriptionStatus.Active => Color.Success,
         Recuria.Client.SubscriptionStatus.Trial => Color.Info,
         Recuria.Client.SubscriptionStatus.PastDue => Color.Warning,
         Recuria.Client.SubscriptionStatus.Canceled => Color.Error,
         Recuria.Client.SubscriptionStatus.Expired => Color.Default,
         _ => Color.Default
     };
}
