@page "/register"
@inject IDialogService DialogService
@using System.Globalization
@using Recuria.Client
@inject Recuria.Blazor.Services.App.IAuthAppService AuthApi
@inject Recuria.Blazor.Services.AuthState Auth
@inject NavigationManager Nav

<PageTitle>Create Account</PageTitle>

<MudStack Spacing="3" Style="max-width:560px;">
    <MudText Typo="Typo.h4">Create Organization</MudText>
    <MudText Typo="Typo.body2">Input your organization name, email, and password.</MudText>

    @if(string.IsNullOrWhiteSpace(_validationMessage))
    {
        <MudAlert Severity="Severity.Warning" Dense="true">@_validationMessage</MudAlert>
    }
    else
    {
        <MudPaper Class="pa-4">
            <MudStack Spacing="2">
                <MudTextField @bind-Value="_organizationName" Label="Organization Name" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="_email" Label="Email" Variant="Variant.Outlined" />
                <MudTextField @bind-Value="_password" Label="Password" InputType="InputType.Password" Variant="Variant.Outlined" />
                <MudSelect T="Recuria.Client.PlanType"
                           Label="Select Plan"
                           Variant="Variant.Outlined"
                           Dense="true"
                           @bind-Value="_selectedPlan">

                    <MudSelectItem Value="Recuria.Client.PlanType.Free">Free</MudSelectItem>
                    <MudSelectItem Value="Recuria.Client.PlanType.Pro">Pro</MudSelectItem>
                    <MudSelectItem Value="Recuria.Client.PlanType.Enterprise">Enterprise</MudSelectItem>
                </MudSelect>
            </MudStack>
        </MudPaper>
    }

</MudStack>

@code {
    [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }

    private string _organizationName = "";
    private string _email = "";
    private string _password = "";
    private Recuria.Client.PlanType _selectedPlan = Recuria.Client.PlanType.Free;
    private bool _busy;
    private string? _validationMessage;

    private static string NormalizeReturnUrl(string? returnUrl)
    {
        if (string.IsNullOrWhiteSpace(returnUrl))
            return "/dashboard";

        if (!returnUrl.StartsWith("/", StringComparison.Ordinal) || returnUrl.StartsWith("//", StringComparison.Ordinal))
            return "/dashboard";

        return returnUrl;
    }
}