@page "/users"
@inject Recuria.Blazor.Services.AuthState Auth
@inject Recuria.Blazor.Services.App.IOrganizationAppService OrganizationsApi
@inject Recuria.Blazor.Services.App.IUserAppService UsersApi
@inject Recuria.Blazor.Services.App.IUserContextService UserContextService
@inject IDialogService DialogService

<PageTitle>Users</PageTitle>

@if (_isForbidden)
{
    <ForbiddenState Message="Users management requires Admin or Owner role." />
}
else
{
    <MudStack Spacing="3">
        <MudText Typo="Typo.h4" Style="color:#ffff">Users</MudText>

        @if (!string.IsNullOrWhiteSpace(_blockingMessage))
        {
            <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true">@_blockingMessage</MudAlert>
        }

        <MudForm @ref="_addUserForm">
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudTextField @bind-Value="_search"
                                Label="Search name or email"
                                Variant="Variant.Outlined"
                                Immediate="true" />
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="_newName"
                                Label="Name"
                                Variant="Variant.Outlined"
                                Validation="@(v => ValidateRequired(v, \"Name\"))" />
                </MudItem>

                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="_newEmail"
                                Label="Email"
                                Variant="Variant.Outlined"
                                Validation="ValidateEmail" />
                </MudItem>

                <MudItem xs="12" md="2">
                    <MudSelect T="Recuria.Client.UserRole"
                            @bind-Value="_newRole"
                            Label="Role"
                            Variant="Variant.Outlined">
                        <MudSelectItem Value="Recuria.Client.UserRole.Owner">Owner</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Admin">Admin</MudSelectItem>
                        <MudSelectItem Value="Recuria.Client.UserRole.Member">Member</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    @if (!string.IsNullOrWhiteSpace(_serverValidationMessage))
                    {
                        <MudAlert Severity="Severity.Warning" Dense="true">@_serverValidationMessage</MudAlert>
                    }

                    <MudStack Row="true" Spacing="2">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_busy" OnClick="AddUser">Add User</MudButton>
                        <MudButton Variant="Variant.Outlined" Disabled="_busy" OnClick="LoadUsers">Refresh</MudButton>
                    </MudStack>
                </MudItem>
            </MudGrid>
        </MudForm>

        <MudTable T="Recuria.Client.UserSummaryDto" Items="FilteredUsers" Dense="true" Hover="true">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Role</MudTh>
                <MudTh></MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.Name</MudTd>
                <MudTd>@context.Email</MudTd>
                <MudTd>@context.Role</MudTd>
                <MudTd>
                    <MudStack Row="true" Spacing="1">
                        <MudButton Variant="Variant.Text" Color="Color.Primary" Disabled="_busy" OnClick="@(() => SelectUser(context))">Select</MudButton>
                        <MudButton Variant="Variant.Text" Color="Color.Error" Disabled="_busy" OnClick="@(() => RemoveUser(context.Id))">Remove</MudButton>
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body2">No users found.</MudText>
            </NoRecordsContent>
        </MudTable>

        @if (_selectedUser is not null)
        {
            <MudCard>
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">Edit Role - @_selectedUser.Email</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <MudSelect T="Recuria.Client.UserRole" @bind-Value="_selectedRole" Label="New Role" Variant="Variant.Outlined">
                            <MudSelectItem Value="Recuria.Client.UserRole.Owner">Owner</MudSelectItem>
                            <MudSelectItem Value="Recuria.Client.UserRole.Admin">Admin</MudSelectItem>
                            <MudSelectItem Value="Recuria.Client.UserRole.Member">Member</MudSelectItem>
                        </MudSelect>

                        <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_busy" OnClick="ChangeRole">Update Role</MudButton>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        }
    </MudStack>
}
@code {
    private bool _busy;
    private bool _isForbidden;
    private string? _blockingMessage;
    private Guid _orgId;

    private string? _search;
    private string? _newName;
    private string? _newEmail;
    private Recuria.Client.UserRole _newRole = Recuria.Client.UserRole.Member;

    private MudForm? _addUserForm;
    private MudForm? _roleForm;
    private string? _serverValidationMessage;

    private List<Recuria.Client.UserSummaryDto> _users = new();
    private Recuria.Client.UserSummaryDto? _selectedUser;
    private Recuria.Client.UserRole _selectedRole = Recuria.Client.UserRole.Member;

    private IEnumerable<Recuria.Client.UserSummaryDto> FilteredUsers =>
        string.IsNullOrWhiteSpace(_search)
            ? _users
            : _users.Where(u =>
                (u.Name ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase) ||
                (u.Email ?? string.Empty).Contains(_search, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        var ctx = await UserContextService.GetAsync();
        if (!ctx.CanManageUsers)
        {
            _isForbidden = true;
            return;
        }
        var orgId = await GetOrganizationIdAsync();
        if (orgId is null)
            return;

        _orgId = orgId.Value;
        // if(!await EnsureOrgContextAsync())
        // {
        //     return;
        // }
        await LoadUsers();
    }

    private async Task AddUser()
    {
        _busy = true;
        _serverValidationMessage = null;

        if (_addUserForm is not null)
        {
            await _addUserForm.Validate();
            if (!_addUserForm.IsValid)
                return;
        }

        try
        {
            var result = await UsersApi.AddAsync(_orgId, new Recuria.Client.AddUserRequest
            {
                UserId = Guid.NewGuid(),
                Name = string.IsNullOrWhiteSpace(_newName) ? _newEmail : _newName,
                Email = _newEmail?.Trim(),
                Role = _newRole
            });
            if (!result.Success)
            {
                _serverValidationMessage = MapServerError(result.Error);
                return;
            }

            await LoadUsers();
            _newName = null;
            _newEmail = null;
            _newRole = Recuria.Client.UserRole.Member;
        }
        finally { _busy = false; }
    }

    private async Task LoadUsers()
    {
        _busy = true;
        try
        {
            var result = await UsersApi.GetAllAsync(_orgId);
            if (!result.Success || result.Data is null)
                return;

            _users = result.Data.ToList();
        }
        finally { _busy = false; }
    }

    private void SelectUser(Recuria.Client.UserSummaryDto user)
    {
        _selectedUser = user;
        _selectedRole = user.Role;
    }

    private async Task ChangeRole()
    {
        if (_selectedUser is null) return;

        _busy = true;
        try
        {
            var result = await UsersApi.ChangeRoleAsync(_orgId, _selectedUser.Id, new Recuria.Client.ChangeUserRoleRequest
            {
                NewRole = _selectedRole
            });
            if (!result.Success)
                return;
            await LoadUsers();
        }
        finally { _busy = false; }
    }

    private async Task RemoveUser(Guid userId)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Confirm Remove",
            "Remove this user from the organization?",
            yesText: "Remove",
            cancelText: "Cancel");

        if (confirmed != true)
            return;

        _busy = true;
        _serverValidationMessage = null;

        try
        {
            var result = await UsersApi.RemoveAsync(_orgId, userId);
            if (!result.Success)
            {
                _serverValidationMessage = MapServerError(result.Error);
                return;
            }

            if (_selectedUser?.Id == userId)
                _selectedUser = null;

            await LoadUsers();
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task<Guid?> GetOrganizationIdAsync()
    {
        var orgIdRaw = await Auth.GetOrgIdAsync();

        if (string.IsNullOrWhiteSpace(orgIdRaw))
        {
            _blockingMessage = "No organization id found. Go to /bootstrap first.";
            return null;
        }

        if (!Guid.TryParse(orgIdRaw, out var orgId))
        {
            _blockingMessage = "Organization id is invalid. Re-bootstrap your session.";
            return null;
        }

        return orgId;
    }

    private static string? ValidateRequired(string? value, string fieldName) => 
        string.IsNullOrWhiteSpace(value) ? $"{fieldName} is required." : null;

    private static string? ValidateEmail(string? value)
    {
        if(string.IsNullOrWhiteSpace(value))
        {
            return "Email is required.";
        }

        return System.Net.Mail.MailAddress.TryCreate(value, out _) ? null : "Email is invalid.";
    }

    private static string MapServerError(string? raw)
    {
        if (string.IsNullOrWhiteSpace(raw)) return "Request failed.";

        if (raw.Contains("validation", StringComparison.OrdinalIgnoreCase))
            return "Some values are invalid. Please review highlighted fields.";

        if (raw.Contains("already exists", StringComparison.OrdinalIgnoreCase))
            return "A user with that email already exists.";

        return raw;
    }
}

