@page "/login"
@inject Recuria.Client.IRecuriaApiClient Api
@inject Recuria.Blazor.Services.AuthState Auth
@inject NavigationManager Nav

<PageTitle>Login</PageTitle>

<MudStack Spacing="3" Style="max-width:560px;">
    <MudText Typo="Typo.h4">Sign In</MudText>
    <MudText Typo="Typo.body2">
        Sign in to continue. This environment uses bootstrap auth for local development.
    </MudText>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error" Dense="true">@_error</MudAlert>
    }

    <MudPaper Class="pa-4">
        <MudStack Spacing="2">
            <MudTextField @bind-Value="_orgName" Label="Organization" Variant="Variant.Outlined" />
            <MudTextField @bind-Value="_ownerEmail" Label="Email" Variant="Variant.Outlined" />
            <MudTextField @bind-Value="_ownerName" Label="Display Name" Variant="Variant.Outlined" />

            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_busy" OnClick="SignIn">
                @(_busy ? "Signing in..." : "Sign In")
            </MudButton>
        </MudStack>
    </MudPaper>
    </MudStack>

@code {
    [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }

    private string _orgName = "Acme Inc";
    private string _ownerEmail = "owner@recuria.local";
    private string _ownerName = "Owner One";
    private bool _busy;
    private string? _error;

    private async Task SignIn()
    {
        if (string.IsNullOrWhiteSpace(_orgName) ||
            string.IsNullOrWhiteSpace(_ownerEmail) ||
            string.IsNullOrWhiteSpace(_ownerName))
        {
            _error = "Organization, email, and display name are required.";
            return;
        }

        _busy = true;
        _error = null;

        try
        {
            var result = await Api.BootstrapAsync(new Recuria.Client.BootstrapRequest
            {
                OrganizationName = _orgName,
                OwnerEmail = _ownerEmail,
                OwnerName = _ownerName
            });

            await Auth.SetAuthAsync(result.Token!, result.OrganizationId.ToString());

            var target = NormalizeReturnUrl(ReturnUrl);
            Nav.NavigateTo(target, forceLoad: false);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private static string NormalizeReturnUrl(string? returnUrl)
    {
        if (string.IsNullOrWhiteSpace(returnUrl))
            return "/dashboard";

        if (!returnUrl.StartsWith("/", StringComparison.Ordinal) || returnUrl.StartsWith("//", StringComparison.Ordinal))
            return "/dashboard";

        return returnUrl;
    }
}
