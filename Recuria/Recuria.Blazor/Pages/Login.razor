@page "/login"
@inject Recuria.Blazor.Services.App.IAuthAppService AuthApi
@inject Recuria.Blazor.Services.AuthState Auth
@inject NavigationManager Nav

<PageTitle>Login</PageTitle>

<MudStack Spacing="3" Style="max-width:560px;">
    <MudText Typo="Typo.h4">Sign In</MudText>
    <MudText Typo="Typo.body2">Use your organization ID, email, and password.</MudText>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error" Dense="true">@_error</MudAlert>
    }

    <MudPaper Class="pa-4">
        <MudStack Spacing="2">
            <MudTextField @bind-Value="_organizationIdText" Label="Organization ID" Variant="Variant.Outlined" />
            <MudTextField @bind-Value="_email" Label="Email" Variant="Variant.Outlined" />
            <MudTextField @bind-Value="_password" Label="Password" InputType="InputType.Password" Variant="Variant.Outlined" />

            <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="_busy" OnClick="SignIn">
                @(_busy ? "Signing in..." : "Sign In")
            </MudButton>
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    [SupplyParameterFromQuery] public string? ReturnUrl { get; set; }

    private string _organizationIdText = "";
    private string _email = "";
    private string _password = "";
    private bool _busy;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        if (await Auth.IsAuthenticatedAsync())
            Nav.NavigateTo("/dashboard", forceLoad: false);
    }

    private async Task SignIn()
    {
        _error = null;

        if (!Guid.TryParse(_organizationIdText, out var organizationId))
        {
            _error = "Organization ID must be a valid GUID.";
            return;
        }

        if (string.IsNullOrWhiteSpace(_email) || string.IsNullOrWhiteSpace(_password))
        {
            _error = "Email and password are required.";
            return;
        }

        _busy = true;

        try
        {
            var result = await AuthApi.LoginAsync(new Recuria.Client.LoginRequest
            {
                OrganizationId = organizationId,
                Email = _email.Trim(),
                Password = _password
            });

            if (!result.Success || result.Data is null)
            {
                _error = result.Error ?? "Sign in failed.";
                return;
            }

            await Auth.SetAuthAsync(result.Data.AccessToken!, result.Data.OrganizationId.ToString());

            var target = NormalizeReturnUrl(ReturnUrl);
            Nav.NavigateTo(target, forceLoad: false);
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private static string NormalizeReturnUrl(string? returnUrl)
    {
        if (string.IsNullOrWhiteSpace(returnUrl))
            return "/dashboard";

        if (!returnUrl.StartsWith("/", StringComparison.Ordinal) || returnUrl.StartsWith("//", StringComparison.Ordinal))
            return "/dashboard";

        return returnUrl;
    }
}
