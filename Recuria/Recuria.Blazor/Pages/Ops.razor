@page "/ops"
@inject Recuria.Blazor.Services.App.IOpsAppService OpsApi
@inject Recuria.Blazor.Services.App.IUserContextService UserContextService
@using System.Globalization

<PageTitle>Ops</PageTitle>
@if (_isForbidden)
{
    <ForbiddenState Message="Ops is restricted to Admin or Owner." />
}
else
{
    <MudStack Spacing="3">
        <MudText Typo="Typo.h4" Style="color:#ffff">Ops</MudText>

        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudNumericField T="int" @bind-Value="_take" Min="1" Max="200" Label="Rows" Variant="Variant.Filled" />
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadDeadLettered" Disabled="_busy">Load</MudButton>
        </MudStack>

        <MudCard>
            <MudCardContent>
                @if (_loading)
                {
                    <MudSkeleton Height="160px" Width="100%" />
                }
                else
                {
                    <MudTable T="Recuria.Client.DeadLetteredOutboxItem"
                              @ref="_table"
                              ServerData="LoadServerDeadLettered"
                              Dense="true"
                              Hover="true"
                              Loading="_tableLoading"
                              RowsPerPage="10">

                        <ToolBarContent>
                            <MudTextField @bind-Value="_search"
                                          Placeholder="Search type or error"
                                          Immediate="true"
                                          Adornment="Adornment.Start"
                                          AdornmentIcon="@Icons.Material.Filled.Search"
                                          OnBlur="OnOpsSearchBlur" />
                        </ToolBarContent>

                        <HeaderContent>
                            <MudTh><MudTableSortLabel T="Recuria.Client.DeadLetteredOutboxItem" SortLabel="deadLetteredOnUtc">Dead-Lettered</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel T="Recuria.Client.DeadLetteredOutboxItem" SortLabel="type">Type</MudTableSortLabel></MudTh>
                            <MudTh><MudTableSortLabel T="Recuria.Client.DeadLetteredOutboxItem" SortLabel="retryCount">Retries</MudTableSortLabel></MudTh>
                            <MudTh>Error</MudTh>
                            <MudTh></MudTh>
                        </HeaderContent>

                        <RowTemplate>
                            <MudTd>@context.DeadLetteredOnUtc.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudTd>
                            <MudTd>@context.Type</MudTd>
                            <MudTd>@context.RetryCount</MudTd>
                            <MudTd>@context.Error</MudTd>
                            <MudTd>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Disabled="_busy" OnClick="@(() => Retry(context.Id))">
                                    Retry
                                </MudButton>
                            </MudTd>
                        </RowTemplate>

                        <NoRecordsContent>
                            <StandardTableState Loading="_tableLoading" Error="_tableError" HasRows="false" EmptyText="No dead-lettered messages." />
                        </NoRecordsContent>
                    </MudTable>
                }
            </MudCardContent>
        </MudCard>
    </MudStack>
}

@code {
    private bool _loading = true;
    private bool _isForbidden;
    private bool _busy;
    private int _take = 50;
    private List<Recuria.Client.DeadLetteredOutboxItem> _items = new();

    private MudTable<Recuria.Client.DeadLetteredOutboxItem>? _table;
    private bool _tableLoading;
    private string? _tableError;
    private string? _search;

    protected override async Task OnInitializedAsync() 
    {        
        var ctx = await UserContextService.GetAsync();
        if (!ctx.CanViewOps)
        {
            _isForbidden = true;
            return;
        }
        await LoadDeadLettered();
    }

    private Task LoadDeadLettered()
    {
        if (_table is null)
            return Task.CompletedTask;

        return _table.ReloadServerData();
    }


    private async Task<TableData<Recuria.Client.DeadLetteredOutboxItem>> LoadServerDeadLettered(TableState state, CancellationToken ct)
    {
        _tableLoading = true;
        _tableError = null;

        try
        {
            var page = state.Page + 1;
            var pageSize = state.PageSize;

            var pageResult = await OpsApi.GetDeadLetteredPageAsync(
                page,
                pageSize,
                _search,
                state.SortLabel,
                state.SortDirection == SortDirection.Descending ? "desc" : "asc",
                notifyError: false);

            if (!pageResult.Success || pageResult.Data is null)
            {
                _tableError = pageResult.Error ?? "Unable to load dead-letter queue.";
                return new TableData<Recuria.Client.DeadLetteredOutboxItem>
                {
                    Items = Array.Empty<Recuria.Client.DeadLetteredOutboxItem>(),
                    TotalItems = 0
                };
            }

            // Accurate total count (temporary extra call)
            var totalResult = await OpsApi.GetDeadLetteredAsync(200, notifyError: false);
            var total = totalResult.Success && totalResult.Data is not null ? totalResult.Data.Count : pageResult.Data.Count;

            return new TableData<Recuria.Client.DeadLetteredOutboxItem>
            {
                Items = pageResult.Data,
                TotalItems = total
            };
        }
        finally
        {
            _tableLoading = false;
        }
    }

    private Task OnOpsSearchBlur(FocusEventArgs _)
    {
        if(_table is null)
        {
            return Task.CompletedTask;
        }

        return _table.ReloadServerData();
    }


    private async Task Retry(Guid id)
    {
        _busy = true;

        try
        {
            var result = await OpsApi.RetryAsync(id);
            if (!result.Success)
                return;

            await LoadDeadLettered();
        }
        finally
        {
            _busy = false;
        }
    }
}
