@page "/invoices"
@inject Recuria.Blazor.Services.AuthState Auth
@inject Recuria.Blazor.Services.App.IInvoiceAppService InvoicesApi
@inject Recuria.Blazor.Services.App.IUserContextService UserContextService
@inject IDialogService DialogService
@inject NavigationManager Nav
@using System.Globalization

<PageTitle>Invoices</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4" Style="color:#ffff">Invoices</MudText>

    @if (!string.IsNullOrWhiteSpace(_blockingMessage))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">
            @_blockingMessage
        </MudAlert>
    }

    <MudCard Class="invoice-card">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Create Invoice</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        @if (_canManageBilling)
        {
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudNumericField T="double"
                                Label="Amount"
                                Variant="Variant.Filled"
                                Margin="Margin.Dense"
                                Min="0.01"
                                @bind-Value="_newAmount" />
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudTextField Label="Description"
                                Variant="Variant.Outlined"
                                Margin="Margin.Dense"
                                @bind-Value="_newDescription" />
                    </MudItem>
                    @if (!string.IsNullOrWhiteSpace(_serverValidationMessage))
                    {
                        <MudAlert Severity="Severity.Warning" Dense="true">@_serverValidationMessage</MudAlert>
                    }
                    else
                    {
                        <MudItem xs="12" md="2" Class="invoice-actions">
                        <MudButton Variant="Variant.Filled"
                            Color="Color.Primary"
                            FullWidth="true"
                            Disabled="@(_busy || _newAmount <= 0)"
                            OnClick="CreateInvoice">
                            Create
                        </MudButton>
                    </MudItem>
                    }                    
                </MudGrid>
            </MudCardContent>
        }
        else
        {
            <MudAlert Severity="Severity.Info" Dense="true">
                Creating invoices requires Admin or Owner role.
            </MudAlert>
        }        
    </MudCard>

    <MudCard Class="invoice-card">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Invoice History</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Text" Disabled="_busy" onclick="LoadInvoices">Refresh</MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            @if(_loading)
            {
                <MudSkeleton Height="180px" Width="100%"/>
            }
            else
            {
                <MudTable T="Recuria.Client.InvoiceListItemDto"
                          @ref="_table"
                          ServerData="LoadServerInvoices"
                          Dense="true"
                          Hover="true"
                          Loading="_tableLoading"
                          RowsPerPage="10">

                    <ToolBarContent>
                        <MudTextField @bind-Value="_tableSearch"
                                      Placeholder="Search by status"
                                      Immediate="true"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      OnBlur="OnInvoiceSearchBlur" />
                    </ToolBarContent>

                    <HeaderContent>
                        <MudTh><MudTableSortLabel T="Recuria.Client.InvoiceListItemDto" SortLabel="issuedOnUtc">Issued</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="Recuria.Client.InvoiceListItemDto" SortLabel="total">Total</MudTableSortLabel></MudTh>
                        <MudTh><MudTableSortLabel T="Recuria.Client.InvoiceListItemDto" SortLabel="status">Status</MudTableSortLabel></MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>@context.IssuedOnUtc.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudTd>
                        <MudTd>@FormatMoney(context.Total?.Amount, context.Total?.Currency)</MudTd>
                        <MudTd>
                            <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(context.Status)">
                                @(context.Status ?? "Unknown")
                            </MudChip>
                        </MudTd>
                        <MudTd>
                            <MudButton Variant="Variant.Text" Color="Color.Primary" OnClick="@(() => OpenDetails(context.Id))">
                                View
                            </MudButton>
                        </MudTd>
                    </RowTemplate>

                    <NoRecordsContent>
                        <StandardTableState Loading="_tableLoading" Error="_tableError" HasRows="false" EmptyText="No invoices found." />
                    </NoRecordsContent>
                </MudTable>
            }
        </MudCardContent>
    </MudCard>
</MudStack>

@code {
    private bool _canManageBilling;
    private bool _loading = true;
    private bool _busy;
    private string? _blockingMessage;
    private string? _serverValidationMessage;
    private Guid _orgId;
    private MudTable<Recuria.Client.InvoiceListItemDto>? _table;
    private bool _tableLoading;
    private string? _tableError;
    private string? _tableSearch;

    private double _newAmount = 49.00;
    private string? _newDescription = "Monthly subscription";

    private List<Recuria.Client.InvoiceListItemDto> _invoices = new();

    protected override async Task OnInitializedAsync()
    {
        var ctx = await UserContextService.GetAsync();
        _canManageBilling = ctx.CanManageBilling;
        await LoadInvoices();
    }

    private async Task LoadInvoices()
{
    _blockingMessage = null;

    var orgId = await GetOrganizationIdAsync();
    if (orgId is null)
        return;

    _orgId = orgId.Value;

    if (_table is not null)
        await _table.ReloadServerData();
}

    private async Task CreateInvoice()
    {
        if(_newAmount <= 0)
        {
            _blockingMessage = "Amount must be greater than 0.";
            return;
        }
        _busy = true;
        _blockingMessage = null;

        try
        {
            var confirmed = await DialogService.ShowMessageBox(
                "Create Invoice",
                $"Create invoice for {FormatMoney(_newAmount, "USD")}?",
                yesText: "Create",
                cancelText: "Cancel");

            if (confirmed != true)
                return;
            var createResult = await InvoicesApi.CreateAsync(new Recuria.Client.CreateInvoiceRequest
            {
                OrganizationId = _orgId,
                Amount = _newAmount,
                Description = string.IsNullOrWhiteSpace(_newDescription) ? null : _newDescription.Trim()
            });
            if (!createResult.Success)
            {
                _serverValidationMessage = createResult.Error;
                return;    
            }
            

            await LoadInvoices();
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task<TableData<Recuria.Client.InvoiceListItemDto>> LoadServerInvoices(TableState state, CancellationToken ct)
    {
        _tableLoading = true;
        _tableError = null;

        try
        {
            var page = state.Page + 1;
            var pageSize = state.PageSize;

            var pageResult = await InvoicesApi.GetPageAsync(
                _orgId,
                page,
                pageSize,
                _tableSearch,
                state.SortLabel,
                state.SortDirection == SortDirection.Descending ? "desc" : "asc",
                notifyError: false);

            if (!pageResult.Success || pageResult.Data is null)
            {
                _tableError = pageResult.Error ?? "Unable to load invoices.";
                return new TableData<Recuria.Client.InvoiceListItemDto>
                {
                    Items = Array.Empty<Recuria.Client.InvoiceListItemDto>(),
                    TotalItems = 0
                };
            }

            // Accurate total count (temporary extra call)
            var totalResult = await InvoicesApi.GetByOrganizationAsync(_orgId, notifyError: false);
            var total = totalResult.Success && totalResult.Data is not null ? totalResult.Data.Count : pageResult.Data.Count;

            return new TableData<Recuria.Client.InvoiceListItemDto>
            {
                Items = pageResult.Data,
                TotalItems = total
            };
        }
        finally
        {
            _tableLoading = false;
        }
    }

    private async Task<Guid?> GetOrganizationIdAsync()
    {
        var orgIdRaw = await Auth.GetOrgIdAsync();

        if (string.IsNullOrWhiteSpace(orgIdRaw))
        {
            _blockingMessage = "No organization id found. Go to /bootstrap first.";
            return null;
        }

        if (!Guid.TryParse(orgIdRaw, out var orgId))
        {
            _blockingMessage = "Organization id is invalid. Re-bootstrap your session.";
            return null;
        }

        return orgId;
    }

    private Task OnInvoiceSearchBlur(FocusEventArgs _)
    {
        if (_table is null)
            return Task.CompletedTask;

        return _table.ReloadServerData();
    }


    private void OpenDetails(Guid id) => Nav.NavigateTo($"/invoices/{id}");

    private static string FormatMoney(double? amount, string? currency)
    {
        var value = amount ?? 0;
        var code = string.IsNullOrWhiteSpace(currency) ? "USD" : currency.ToUpperInvariant();
        var symbol = code == "USD" ? "$" : code + " ";
        return $"{symbol}{value:N2}";
    }

    private static Color GetStatusColor(string? status) =>
        status?.ToLowerInvariant() switch
        {
            "paid" => Color.Success,
            "open" => Color.Info,
            "pending" => Color.Warning,
            "failed" => Color.Error,
            "void" => Color.Default,
            _ => Color.Default
        };
}

