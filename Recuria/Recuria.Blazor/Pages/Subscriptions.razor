@page "/subscriptions"
@inject Recuria.Blazor.Services.AuthState Auth
@inject Recuria.Blazor.Services.App.ISubscriptionAppService SubscriptionsApi
@inject Recuria.Blazor.Services.App.IUserContextService UserContextService
@using System.Globalization
@using Recuria.Client

<PageTitle>Subscriptions</PageTitle>

<MudStack Spacing="3" Class="subs-page">
    <MudText Typo="Typo.h4" Style="color:#ffff">Subscriptions</MudText>
    @if (!string.IsNullOrWhiteSpace(_blockingMessage))
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true">
            @_blockingMessage
        </MudAlert>
    }

    @if (_loading)
    {
        <MudSkeleton Height="220px" Width="100%" />
    }
    else if(_details is null)
    {
        <MudAlert Severity="Severity.Warning" Dense="true">
            No subscription data available.
        </MudAlert>
        @if (_canManageBilling)
        {
            <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               Disabled="_busy"
               OnClick="CreateTrial">
                Start Trial
            </MudButton>
        }
        else
        {
            <MudText Typo="Typo.caption" Color="Color.Secondary">
                Starting a trial requires Admin or Owner role.
            </MudText>
        }
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="7">
                <MudCard Class="subs-card">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Current Subscription</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="1" Class="subs-meta">
                            <MudText><b>Plan:</b> @PlanLabel(_details.Subscription.PlanCode)</MudText>
                            <MudText>
                                <b>Status:</b>
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_details.Subscription.Status)">
                                    @_details.Subscription.Status.ToString()
                                </MudChip>
                            </MudText>
                            <MudText><b>Trial:</b> @(_details.Subscription.IsTrial ? "Yes" : "No")</MudText>
                            <MudText><b>Past Due:</b> @(_details.Subscription.IsPastDue ? "Yes" : "No")</MudText>
                            <MudText><b>Period Start:</b> @_details.Subscription.PeriodStart.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudText>
                            <MudText><b>Period End:</b> @_details.Subscription.PeriodEnd.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudText>
                            <MudText><b>Subscription Id:</b> @_details.Subscription.Id</MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="7" >
                <MudCard Class="subs-card">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Actions</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="2" Class="subs-actions">
                            <MudSelect T="Recuria.Client.PlanType"
                                Label="Select Plan"
                                Variant="Variant.Outlined"
                                Dense="true"
                                @bind-Value="_selectedPlan">

                                <MudSelectItem Value="Recuria.Client.PlanType.Free">Free</MudSelectItem>
                                <MudSelectItem Value="Recuria.Client.PlanType.Pro">Pro</MudSelectItem>
                                <MudSelectItem Value="Recuria.Client.PlanType.Enterprise">Enterprise</MudSelectItem>
                            </MudSelect>

                            @if (!_canManageBilling)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    Plan changes require Admin or Owner role.
                                </MudText>
                            }
                            else
                            {
                                <MudButton Variant="Variant.Filled"
                                    Color="Color.Primary"
                                    Disabled="@(!_canUpgrade || _busy || _selectedPlan == _details.Subscription.PlanCode)"
                                    OnClick="UpgradePlan">
                                Upgrade / Change Plan
                                </MudButton>

                                <MudButton Variant="Variant.Outlined"
                                        Color="Color.Error"
                                        Disabled="@(!_canCancel || _busy)"
                                        OnClick="CancelSubscription">
                                    @(_details?.Subscription.Status == Recuria.Client.SubscriptionStatus.Trial
                                        ? "End Trial"
                                        : "Cancel Subscription")
                                </MudButton>
                                @if (!_canCancel)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        Cancellation is only available for trial, active, or past-due subscriptions.
                                    </MudText>
                                }
                            }
                            <MudButton Variant="Variant.Text"
                                       Color="Color.Default"
                                       Disabled="_busy"
                                       OnClick="LoadData">
                                Refresh
                            </MudButton>
                            
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }

</MudStack>
@code {
    private string? _blockingMessage;
    private bool _canManageBilling;
    private bool _loading;
    private bool _busy;
    private Guid _orgId;
    private Recuria.Client.SubscriptionDetailsDto? _details;
    private Recuria.Client.PlanType _selectedPlan = Recuria.Client.PlanType.Free;
    private bool _canUpgrade;
    private bool _canCancel;

    protected override async Task OnInitializedAsync()
    {
        var ctx = await UserContextService.GetAsync();
        _canManageBilling = ctx.CanManageBilling;
        await LoadData();
    }

    private async Task LoadData()
    {
        _loading = true;
        _blockingMessage = null;

        try
        {
            var orgId = await GetOrganizationIdAsync();
            if(orgId is null)
            {                
                return;
            }

            _orgId = orgId.Value;
            var result = await SubscriptionsApi.GetCurrentAsync(_orgId, notifyError: false);
            if (!result.Success)
            {
                _details = null;
                _canCancel = false;
                _canUpgrade = false;
                return;
            }

            _details = result.Data;
            if (_details is null)
            {
                return;
            }

            _selectedPlan = _details.Subscription.PlanCode;
            _canCancel = _details.Actions.CanCancel;
            _canUpgrade = _details.Actions.CanUpgrade;
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task UpgradePlan()
    {
        if(_details is null)
        {
            return;
        }

        _busy = true;

        try
        {
            var result = await SubscriptionsApi.UpgradeAsync(_details.Subscription.Id, new Recuria.Client.UpgradeSubscriptionRequest
            {
                NewPlan = _selectedPlan
            });
            if (!result.Success)
                return;

            await LoadData();
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task CancelSubscription()
    {
        if (_details is null)
            return;

        _busy = true;

        try
        {
            var result = await SubscriptionsApi.CancelAsync(_details.Subscription.Id);
            if (!result.Success)
                return;
            await LoadData();
        }
        finally
        {
            _busy = false;
        }
    }    

    private async Task CreateTrial()
    {
        if (!_canManageBilling)
            return;

        _busy = true;

        try
        {
            var result = await SubscriptionsApi.CreateTrialAsync(_orgId);
            if (!result.Success)
                return;
            await LoadData();
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task<Guid?> GetOrganizationIdAsync()
    {
        var orgIdRaw = await Auth.GetOrgIdAsync();

        if (string.IsNullOrWhiteSpace(orgIdRaw))
        {
            _blockingMessage = "No organization id found. Go to /bootstrap first.";
            return null;
        }

        if (!Guid.TryParse(orgIdRaw, out var orgId))
        {
            _blockingMessage = "Organization id is invalid. Re-bootstrap your session.";
            return null;
        }

        return orgId;
    }


    private static string PlanLabel(Recuria.Client.PlanType plan) =>
        plan switch
        {
            Recuria.Client.PlanType.Free => "Free",
            Recuria.Client.PlanType.Pro => "Pro",
            Recuria.Client.PlanType.Enterprise => "Enterprise",
            _ => plan.ToString()
        };

    private static Color GetStatusColor(Recuria.Client.SubscriptionStatus status) =>
        status switch
        {
            Recuria.Client.SubscriptionStatus.Active => Color.Success,
            Recuria.Client.SubscriptionStatus.Trial => Color.Info,
            Recuria.Client.SubscriptionStatus.PastDue => Color.Warning,
            Recuria.Client.SubscriptionStatus.Canceled => Color.Error,
            Recuria.Client.SubscriptionStatus.Expired => Color.Default,
            _ => Color.Default
        };
}

