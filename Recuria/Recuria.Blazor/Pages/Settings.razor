@page "/settings"
@inject Recuria.Blazor.Services.AuthState Auth
@inject Recuria.Blazor.Services.App.IAuthAppService AuthApi
@inject Recuria.Blazor.Services.App.IOrganizationAppService OrganizationsApi
@inject Recuria.Blazor.Services.App.ISubscriptionAppService SubscriptionsApi
@using System.Globalization

<PageTitle>Settings</PageTitle>

<MudStack Spacing="3">
    <MudText Typo="Typo.h4" Style="color:#ffff">Settings</MudText>

    @if (!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Dense="true">@_error</MudAlert>
    }

    <MudGrid AlignItems="Stretch">
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader><CardHeaderContent><MudText Typo="Typo.h6">Session</MudText></CardHeaderContent></MudCardHeader>
                <MudCardContent>
                    @if (_whoami is null)
                    {
                        <MudText Typo="Typo.body2">Loading...</MudText>
                    }
                    else
                    {
                        <MudText><b>Subject:</b> @_whoami.Subject</MudText>
                        <MudText><b>Organization:</b> @_whoami.OrganizationId</MudText>
                        <MudText><b>Role:</b> @_whoami.Role</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader><CardHeaderContent><MudText Typo="Typo.h6">Organization</MudText></CardHeaderContent></MudCardHeader>
                <MudCardContent>
                    @if(_org is null)
                    {
                        <MudText Typo="Typo.body2">Loading...</MudText>
                    }
                    else
                    {
                        <MudText><b>Name:</b> @_org.Name</MudText>
                        <MudText><b>Owner:</b> @_org.OwnerEmail</MudText>
                        <MudText><b>Users:</b> @_org.UserCount</MudText>
                        <MudText><b>Created:</b> @_org.CreatedAt.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudText>
                    }
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <MudCard>
        <MudCardHeader><CardHeaderContent><MudText Typo="Typo.h6">Current Subscription</MudText></CardHeaderContent></MudCardHeader>
        <MudCardContent>
            @if(_subscription is null)
            {
                <MudText Typo="Typo.body2">No current subscription.</MudText>
            }
            else
            {
                <MudText><b>Plan:</b>@_subscription.Subscription.PlanCode</MudText>
                <MudText><b>Status:</b> @_subscription.Subscription.Status</MudText>
                <MudText><b>Start:</b> @_subscription.Subscription.PeriodStart.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudText>
                <MudText><b>End:</b> @_subscription.Subscription.PeriodEnd.ToLocalTime().ToString("g", CultureInfo.CurrentCulture)</MudText>
            }
        </MudCardContent>
    </MudCard>

    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadAll" Disabled="_loading">
        Refresh
    </MudButton>
</MudStack>

@code {
    private bool _loading;
    private string? _error;
    private Recuria.Client.WhoAmIResponse? _whoami;
    private Recuria.Client.OrganizationDto? _org;
    private Recuria.Client.SubscriptionDetailsDto? _subscription;

    protected override async Task OnInitializedAsync() => await LoadAll();

    private async Task LoadAll()
    {
        _loading = true;
        _error = null;

        try
        {
            var whoResult = await AuthApi.WhoAmIAsync(notifyError: false);
            if (whoResult.Success)
                _whoami = whoResult.Data;

            var orgResult = await OrganizationsApi.GetMineAsync(notifyError: false);
            if (orgResult.Success)
                _org = orgResult.Data;

            var orgIdRaw = await Auth.GetOrgIdAsync();
            if (string.IsNullOrWhiteSpace(orgIdRaw))
            {
                _subscription = null;
            }
            else
            {
                var orgId = Guid.Parse(orgIdRaw);
                var subResult = await SubscriptionsApi.GetCurrentAsync(orgId, notifyError: false);
                _subscription = subResult.Success ? subResult.Data : null;
            }
        }
        catch(Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}

