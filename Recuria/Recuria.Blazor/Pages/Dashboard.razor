@page "/dashboard"
@inject Recuria.Blazor.Services.AuthState Auth
@inject Recuria.Blazor.Services.App.IOrganizationAppService Organizations
@inject Recuria.Blazor.Services.App.ISubscriptionAppService Subscriptions

<PageTitle>Dashboard</PageTitle>

<MudStack Spacing="3">
    <MudText Style="color:#ffff" Typo="Typo.h4">Dashboard</MudText>

    @if (_loading)
    {
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudSkeleton Height="180px" Width="100%" />
            </MudItem>
            <MudItem xs="12" md="6">
                <MudSkeleton Height="180px" Width="100%" />
            </MudItem>
        </MudGrid>
    }
    else if (_blockingMessage is not null)
    {
        <MudAlert Severity="Severity.Warning" Variant="Variant.Filled" Dense="true">
            @_blockingMessage
        </MudAlert>

        <MudButton Variant="Variant.Outlined" Color="Color.Primary" Href="/bootstrap" StartIcon="@Icons.Material.Filled.RocketLaunch">
            Go to Bootstrap
        </MudButton>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Organization</MudText>
                            <MudText>@_organizationName</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Spacing="1">
                            <MudText><b>Plan:</b>@_subscription?.Subscription?.PlanCode</MudText>
                            <MudText>
                                <b>Status:</b>
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(_subscription?.Subscription?.Status)">
                                    @(_subscription?.Subscription?.Status.ToString() ?? "Unknown")
                                </MudChip>
                            </MudText>
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
    </MudStack>

@code {
    private bool _loading = true;
    private string? _blockingMessage;
    private Recuria.Client.SubscriptionDetailsDto? _subscription;
    private string _organizationName = "unknown";

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var orgId = await GetOrganizationIdAsync();
            if (orgId is null)
                return;

            var parsedOrgId = orgId.Value;
            var orgResult = await Organizations.GetByIdAsync(parsedOrgId);
            if (!orgResult.Success || orgResult.Data is null)
            {
                _blockingMessage = "Unable to load organization.";
                return;
            }

            var subResult = await Subscriptions.GetCurrentAsync(parsedOrgId);
            if (!subResult.Success || subResult.Data is null){
                _blockingMessage = "Unable to load subscription.";
                return;
            }
           
            _subscription = subResult.Data;
            _organizationName = orgResult.Data.Name ?? "unknown";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task<Guid?> GetOrganizationIdAsync()
    {
        var orgIdRaw = await Auth.GetOrgIdAsync();

        if (string.IsNullOrWhiteSpace(orgIdRaw))
        {
            _blockingMessage = "No organization id found. Go to /bootstrap first.";
            return null;
        }

        if (!Guid.TryParse(orgIdRaw, out var orgId))
        {
            _blockingMessage = "Organization id is invalid. Re-bootstrap your session.";
            return null;
        }

        return orgId;
    }


    private static Color GetStatusColor(Recuria.Client.SubscriptionStatus? status) =>
     status switch
     {
         Recuria.Client.SubscriptionStatus.Active => Color.Success,
         Recuria.Client.SubscriptionStatus.Trial => Color.Info,
         Recuria.Client.SubscriptionStatus.PastDue => Color.Warning,
         Recuria.Client.SubscriptionStatus.Canceled => Color.Error,
         Recuria.Client.SubscriptionStatus.Expired => Color.Default,
         _ => Color.Default
     };
}

