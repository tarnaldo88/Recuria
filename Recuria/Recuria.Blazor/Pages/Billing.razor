@page "/billing"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@inject Recuria.Blazor.Services.App.IPaymentAppService Payments
@inject Recuria.Blazor.Services.App.IUserContextService UserContext
@inject NavigationManager Nav

<MudPaper Class="pa-4 d-flex flex-column gap-3">
    <MudText Typo="Typo.h5">Billing</MudText>
    <MudText Typo="Typo.body2">Start Stripe checkout for a subscription plan.</MudText>

    <MudTextField @bind-Value="_priceId" Label="Stripe Price ID" Variant="Variant.Outlined" />
    <MudNumericField T="int" @bind-Value="_quantity" Label="Quantity" Variant="Variant.Outlined" Min="1" />

    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@_busy" OnClick="StartCheckout">
        @(_busy ? "Redirecting..." : "Start Checkout")
    </MudButton>

    @if(!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }
    </MudPaper>

@code {
    private string _priceId = "";
    private int _quantity = 1;
    private bool _busy;
    private string? _error;

    private async Task StartCheckout()
    {
        _error = null;
        _busy = true;

        try
        {
            var ctx = await UserContext.GetAsync();

            if (!ctx.IsAuthenticated || ctx.OrganizationId is null)
            {
                _error = "You must be signed in with an organization context.";
                return;
            }

            if (string.IsNullOrWhiteSpace(_priceId))
            {
                _error = "Price ID is required.";
                return;
            }

            var result = await Payments.CreateCheckoutUrlAsync(ctx.OrganizationId.Value, _priceId.Trim(), _quantity);
            if (!result.Success || string.IsNullOrWhiteSpace(result.Data))
            {
                _error = result.Error ?? "Unable to create checkout session.";
                return;
            }

            Nav.NavigateTo(result.Data, forceLoad: true);
        }
        finally
        {
            _busy = false;
        }
    }
}
