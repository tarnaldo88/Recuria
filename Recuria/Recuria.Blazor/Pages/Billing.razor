@page "/billing"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@inject Recuria.Blazor.Services.App.IPaymentAppService Payments
@inject Recuria.Blazor.Services.App.IUserContextService UserContext
@inject NavigationManager Nav

<MudPaper Class="pa-4 d-flex flex-column gap-3">
    <MudText Typo="Typo.h5">Billing</MudText>
    <MudText Typo="Typo.body2">Start Stripe checkout for a subscription plan.</MudText>

    <MudSelect T="string" Label="Plan" @bind-Value="_selectedPlanCode" Variant="Variant.Outlined">
        @foreach (var p in _plans)
        {
            <MudSelectItem Value="@p.Code">@($"{p.Name} - {(p.AmountCents / 100m):C}/{p.Interval}")</MudSelectItem>
        }
    </MudSelect>

    <MudNumericField T="int" @bind-Value="_quantity" Label="Quantity" Variant="Variant.Outlined" Min="1" />

    <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@_busy" OnClick="StartCheckout">
        @(_busy ? "Redirecting..." : "Start Checkout")
    </MudButton>

    @if(!string.IsNullOrWhiteSpace(_error))
    {
        <MudAlert Severity="Severity.Error">@_error</MudAlert>
    }
    </MudPaper>

@code {
    private readonly List<Recuria.Blazor.Services.App.BillingPlanVm> _plans = new();
    private string _selectedPlanCode = "";
    private int _quantity = 1;
    private bool _busy;
    private string? _error;

    protected override async Task OnInitializedAsync()
    {
        var plansResult = await Payments.GetPlansAsync(notifyError: false);
        if (!plansResult.Success || plansResult.Data is null)
        {
            _error = plansResult.Error ?? "Unable to load billing plans.";
            return;
        }

        _plans.AddRange(plansResult.Data);
        _selectedPlanCode = _plans.FirstOrDefault()?.Code ?? "";
    }

    private async Task StartCheckout()
    {
        _error = null;
        _busy = true;

        try
        {
            var ctx = await UserContext.GetAsync();

            if (!ctx.IsAuthenticated || ctx.OrganizationId is null)
            {
                _error = "You must be signed in with an organization context.";
                return;
            }

            if (string.IsNullOrWhiteSpace(_selectedPlanCode))
            {
                _error = "Select a billing plan.";
                return;
            }

            var checkoutResult = await Payments.CreateCheckoutUrlAsync(
                ctx.OrganizationId.Value,
                _selectedPlanCode,
                _quantity);

            if (!checkoutResult.Success || string.IsNullOrWhiteSpace(checkoutResult.Data))
            {
                _error = checkoutResult.Error ?? "Unable to create checkout session.";
                return;
            }

            Nav.NavigateTo(checkoutResult.Data, forceLoad: true);
        }
        finally
        {
            _busy = false;
        }
    }
}